<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sahara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .dashboard-card {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
        }
    </style>
</head>
<body class="min-h-screen" x-data="dashboard()" x-init="init()">
    <!-- Header -->
    <header class="px-4 py-6">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="/chat" class="hover:opacity-80 transition-opacity">
                <h1 class="text-3xl font-bold text-white">
                    üå∏ Sahara AI - Welcome back, 
                    <span x-text="userData.is_authenticated ? userData.username : 'Guest'"></span>!
                </h1>
                <p class="text-white/80">Your wellness journey dashboard</p>
            </a>
            <div class="flex gap-3">
                <a href="/chat" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                    <i class="fas fa-comment mr-2"></i>Chat
                </a>
                <a href="/mood-analytics" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                    <i class="fas fa-heart mr-2"></i>Mood
                </a>
                <a href="/resources" class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                    <i class="fas fa-book mr-2"></i>Resources
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 pb-12">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card dashboard-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-2">üí¨</div>
                <div class="text-2xl font-bold text-white" x-text="stats.totalChats"></div>
                <div class="text-white/70 text-sm">Total Chats</div>
            </div>
            <div class="stat-card dashboard-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-2">üìä</div>
                <div class="text-2xl font-bold text-white" x-text="stats.moodEntries"></div>
                <div class="text-white/70 text-sm">Mood Entries</div>
            </div>
            <div class="stat-card dashboard-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-2">üî•</div>
                <div class="text-2xl font-bold text-white" x-text="stats.streakDays"></div>
                <div class="text-white/70 text-sm">Day Streak</div>
            </div>
            <div class="stat-card dashboard-card rounded-xl p-6 text-center">
                <div class="text-3xl mb-2" x-text="stats.currentMoodEmoji"></div>
                <div class="text-lg font-bold text-white" x-text="stats.currentMood"></div>
                <div class="text-white/70 text-sm">Current Mood</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Mood Trend Chart -->
            <div class="dashboard-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fas fa-chart-line mr-2"></i>
                    Mood Trends (Last 7 Days)
                </h3>
                <div class="bg-white/10 rounded-lg p-4">
                    <canvas id="moodChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Activity Overview -->
            <div class="dashboard-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    Weekly Activity
                </h3>
                <div class="space-y-3">
                    <template x-for="activity in weeklyActivity" :key="activity.day">
                        <div class="flex justify-between items-center">
                            <span class="text-white" x-text="activity.day"></span>
                            <div class="flex items-center">
                                <div class="w-24 bg-white/20 rounded-full h-2 mr-3">
                                    <div 
                                        class="bg-gradient-to-r from-purple-400 to-pink-400 h-2 rounded-full transition-all duration-300"
                                        :style="`width: ${activity.progress}%`"
                                    ></div>
                                </div>
                                <span class="text-white/70 text-sm" x-text="activity.chats + ' chats'"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Mood Entries -->
            <div class="dashboard-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fas fa-heart mr-2"></i>
                    Recent Mood Entries
                </h3>
                <div x-show="recentMoods.length === 0" class="text-center py-8">
                    <div class="text-4xl mb-3">üìù</div>
                    <p class="text-white/70">No mood entries yet</p>
                    <a href="/mood-analytics" class="text-purple-300 hover:text-purple-200 underline">
                        Start mood tracking
                    </a>
                </div>
                <div class="space-y-3">
                    <template x-for="mood in recentMoods" :key="mood.id">
                        <div class="bg-white/10 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3" x-text="mood.mood_emoji"></span>
                                <div>
                                    <div class="text-white font-medium" x-text="mood.mood_label"></div>
                                    <div class="text-white/60 text-sm" x-text="formatDate(mood.timestamp)"></div>
                                </div>
                            </div>
                            <div class="text-white/70 text-sm" x-text="`Intensity: ${mood.mood_intensity}/10`"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Achievements -->
            <div class="dashboard-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fas fa-trophy mr-2"></i>
                    Achievements
                </h3>
                <div class="space-y-3">
                    <div class="bg-yellow-500/20 rounded-lg p-3 border border-yellow-500/30">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üéâ</span>
                            <div>
                                <div class="text-white font-medium">Welcome to Sahara!</div>
                                <div class="text-white/70 text-sm">Started your wellness journey</div>
                            </div>
                        </div>
                    </div>
                    
                    <div x-show="stats.totalChats >= 1" class="bg-blue-500/20 rounded-lg p-3 border border-blue-500/30">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üí¨</span>
                            <div>
                                <div class="text-white font-medium">First Chat</div>
                                <div class="text-white/70 text-sm">Had your first conversation with our AI</div>
                            </div>
                        </div>
                    </div>
                    
                    <div x-show="stats.moodEntries >= 1" class="bg-purple-500/20 rounded-lg p-3 border border-purple-500/30">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">üìä</span>
                            <div>
                                <div class="text-white font-medium">Mood Tracker</div>
                                <div class="text-white/70 text-sm">Recorded your first mood entry</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-8 text-center">
            <div class="dashboard-card rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="/mood-analytics" class="bg-purple-500 hover:bg-purple-600 text-white font-bold px-6 py-4 rounded-lg transition-colors">
                        <i class="fas fa-heart mr-2"></i>
                        Mood Analytics
                    </a>
                    <a href="/chat" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-4 rounded-lg transition-colors">
                        <i class="fas fa-comment mr-2"></i>
                        Start Chatting
                    </a>
                    <a href="/resources" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-4 rounded-lg transition-colors">
                        <i class="fas fa-book mr-2"></i>
                        Explore Resources
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                userData: {{ user_data|tojson }},
                stats: {
                    totalChats: 0,
                    moodEntries: 0,
                    streakDays: 1,
                    currentMood: 'Welcome!',
                    currentMoodEmoji: 'üëã'
                },
                recentMoods: [],
                weeklyActivity: [
                    { day: 'Monday', chats: 2, progress: 40 },
                    { day: 'Tuesday', chats: 3, progress: 60 },
                    { day: 'Wednesday', chats: 1, progress: 20 },
                    { day: 'Thursday', chats: 4, progress: 80 },
                    { day: 'Friday', chats: 2, progress: 40 },
                    { day: 'Saturday', chats: 1, progress: 20 },
                    { day: 'Sunday', chats: 0, progress: 0 }
                ],

                async init() {
                    if (this.userData.is_authenticated) {
                        await this.loadUserData();
                    } else {
                        await this.loadGuestData();
                    }
                    this.initChart();
                },

                async loadUserData() {
                    try {
                        // Load mood history for authenticated users
                        const moodResponse = await fetch('/mood-history');
                        if (moodResponse.ok) {
                            const moodData = await moodResponse.json();
                            this.recentMoods = moodData.slice(0, 5); // Last 5 entries
                            this.stats.moodEntries = moodData.length;
                            
                            if (moodData.length > 0) {
                                const latest = moodData[0];
                                this.stats.currentMood = latest.mood_label;
                                this.stats.currentMoodEmoji = latest.mood_emoji;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                    }
                },

                async loadGuestData() {
                    // Load data from localStorage for guest users
                    const guestMoods = JSON.parse(localStorage.getItem('sahara_guest_moods') || '[]');
                    this.recentMoods = guestMoods.slice(0, 5);
                    this.stats.moodEntries = guestMoods.length;
                    
                    if (guestMoods.length > 0) {
                        const latest = guestMoods[0];
                        this.stats.currentMood = latest.mood_label;
                        this.stats.currentMoodEmoji = latest.mood_emoji;
                    }
                },

                initChart() {
                    const ctx = document.getElementById('moodChart');
                    if (!ctx) return;

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Mood Intensity',
                                data: [7, 6, 8, 5, 7, 9, 8],
                                borderColor: 'rgb(168, 85, 247)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: {
                                        color: 'white'
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10,
                                    ticks: {
                                        color: 'white'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: 'white'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            }
        }
    </script>
</body>
</html>